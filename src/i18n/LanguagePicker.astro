---
import { getLangFromUrl, locales, useTranslation, slugify } from ".";
const currentLang = getLangFromUrl(Astro.url);

// Build a map of route slugs per language based on translation labels
const SLUGS: Record<string, Record<string, string>> = {};
const routeKeys = new Set<string>();
for (const [l] of Object.entries(locales)) {
  const t = await useTranslation(l as any);
  SLUGS[l] = {} as Record<string, string>;
  Object.entries(t.AREAS || {}).forEach(([key, label]) => {
    if (key === "SMART_ECOSYSTEM_ITEMS") {
      // We don't add SMART_ECOSYSTEM_ITEMS to routeKeys, but its items.
      (label as any[]).forEach((item, index) => {
        const itemKey = `SMART_ECOSYSTEM_ITEM_${index}`;
        SLUGS[l][itemKey] = slugify(item.TITLE_TEXT);
        routeKeys.add(itemKey);
      });
    } else {
      routeKeys.add(key);
      if (key === "SMART_ECOSYSTEM") {
        SLUGS[l][key] = "";
      } else {
        SLUGS[l][key] = slugify(String(label));
      }
    }
  });
}
const ROUTE_KEYS = Array.from(routeKeys);

const path = Astro.url.pathname;
function detectRouteKey() {
  const parts = path.split("/").filter(Boolean);
  const langInPath = parts[0] || currentLang;
  const slug = decodeURIComponent(parts[1] || "");

  for (const key of ROUTE_KEYS) {
    if (key === "home" && (slug === "" || slug === undefined)) return "home";
    if (SLUGS[langInPath] && SLUGS[langInPath][key] === slug) return key;
  }
  return null;
}

const routeKey = detectRouteKey();

function getPath(lang: string) {
  let newPath = `/${lang}/`;
  if (routeKey && routeKey !== "home") {
    const newSlug = SLUGS[lang] && SLUGS[lang][routeKey];
    if (newSlug) newPath = `/${lang}/${newSlug}/`;
  } else if (!routeKey) {
    const pathParts = path.split("/").filter(Boolean);
    const pagePath = pathParts.slice(1).join("/");
    if (pagePath) {
      newPath = `/${lang}/${pagePath}/`;
    }
  }
  return newPath;
}
---

<div class="language-picker relative group">
  <button
    class="language-toggle h-10 px-4 rounded-full border border-white/25 bg-transparent text-[var(--color-title)] shadow-[0_0_10px_rgba(var(--color-title),0.7)] flex items-center gap-2"
  >
    <span>{currentLang.toUpperCase()}</span>
    <svg
      class="language-arrow fill-current h-4 w-4 transition-transform duration-300 group-hover:rotate-180"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 20 20"
      ><path
        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
      ></path></svg
    >
  </button>
  <div
    class="language-menu top-full backdrop-blur-md left-0 z-20 absolute flex w-full flex-col gap-2 bg-[var(--color-bg-dropdown)] opacity-0 group-hover:opacity-100 shadow-[0_8px_20px_rgba(0,0,0,0.4)] p-[10px] rounded-[8px] transition-all -translate-y-[6px] group-hover:translate-y-0 duration-200 pointer-events-none group-hover:pointer-events-auto"
  >
    {
      Object.entries(locales).map(([lang, label]) => {
        if (lang !== currentLang) {
          return (
            <a
              href={getPath(lang)}
              class="block text-center text-white hover:bg-[var(--color-title)]/10 p-2 rounded-md hover:text-[var(--color-title)] transition-colors"
            >
              {lang.toUpperCase()}
            </a>
          );
        }
      })
    }
  </div>
</div>
