---
import { getLangFromUrl, useTranslation } from "@/i18n";

const { projects } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const i18n = await useTranslation(lang);
---

<section class="flex flex-col gap-16">
  <div class="flex justify-center items-center bg-[var(--color-blue)] py-8">
    <h2
      class="font-bold text-white text-4xl sm:text-5xl text-center"
    >
      {i18n.AREAS.SUCCESS_STORIES_TITLE}
    </h2>
  </div>

  <div class="flex flex-col gap-20 mx-auto px-4 max-w-6xl">
    {
      projects.map((project: any, idx: number) => {
        const images = Array.isArray(project.IMG) ? project.IMG : [project.IMG];
        const isEven = idx % 2 === 0;

        return (
          <article class="flex lg:flex-row flex-col justify-center items-start gap-8 mx-auto w-full max-w-6xl">
            <div
              class:list={[
                "flex flex-col justify-start items-start w-full lg:w-1/2",
                isEven ? "lg:order-1" : "lg:order-2",
              ]}
            >
              <h3
                data-aos="fade-up"
                data-aos-duration="1000"
                class="mb-2 w-full font-semibold text-metal text-2xl lg:text-left text-center"
                set:html={project.TITLE}
              />
              <div class="mt-6 text-white text-lg lg:text-left text-center">
                {project.DATE && (
                  <p data-aos="fade-up" data-aos-duration="1000" class="mb-2">
                    <strong class="font-semibold text-metal text-base lg:text-lg">
                      {i18n.AREAS.SUCCESS_STORIES_YEAR}:
                    </strong>
                    <span class="text-white text-base lg:text-lg">
                      {project.DATE}
                    </span>
                  </p>
                )}
                {project.LOCATE && (
                  <p data-aos="fade-up" data-aos-duration="1000" class="mb-2">
                    <strong class="font-semibold text-metal text-base lg:text-lg">
                      {i18n.AREAS.SUCCESS_STORIES_LOCATE}:
                    </strong>
                    <span class="text-white text-base lg:text-lg">
                      {project.LOCATE}
                    </span>
                  </p>
                )}
                {project.DESCRIPTION && (
                  <div
                    data-aos="fade-up"
                    data-aos-duration="1000"
                    class="text-white text-base lg:text-lg"
                    set:html={project.DESCRIPTION}
                  />
                )}
              </div>
            </div>

            <div
              class:list={[
                "w-full lg:w-1/2",
                isEven ? "lg:order-2" : "lg:order-1",
              ]}
            >
              {images.length === 1 ? (
                <figure
                  data-aos="zoom-in-up"
                  data-aos-duration="1000"
                  class="group after:absolute relative after:inset-0 after:bg-[var(--color-title)] after:opacity-0 hover:after:opacity-40 border border-white/20 rounded-sm overflow-hidden after:transition-all after:duration-400 after:ease-in-out cursor-pointer image-container"
                >
                  <img
                    src={images[0]}
                    alt={project.TITLE}
                    loading="eager"
                    class="w-full h-auto max-h-[70vh] object-cover group-hover:scale-105 transition-all duration-400 ease-in-out"
                  />
                </figure>
              ) : (
                <div class="gap-4 columns-2">
                  {images.map((src: string, j: number) => (
                    <figure
                      data-aos="zoom-in-up"
                      data-aos-duration="1000"
                      class="group after:absolute relative after:inset-0 after:bg-[var(--color-title)] after:opacity-0 hover:after:opacity-40 mb-4 border border-white/20 rounded-sm overflow-hidden break-inside-avoid after:transition-all after:duration-400 after:ease-in-out cursor-pointer image-container"
                    >
                      <img
                        src={src}
                        alt={`${project.TITLE} #${j + 1}`}
                        loading="eager"
                        class="block w-full h-auto object-cover group-hover:scale-105 transition-all duration-400 ease-in-out"
                      />
                    </figure>
                  ))}
                </div>
              )}
            </div>
          </article>
        );
      })
    }
  </div>
</section>

<!-- Modal -->
<div
  id="imageModal"
  data-open="false"
  class="invisible data-[open=true]:visible z-[1001] fixed inset-0 flex justify-center items-center bg-black/85 opacity-0 data-[open=true]:opacity-100 p-4 transition-all duration-300 ease-out"
>
  <div
    class="relative w-auto max-w-[95%] h-auto max-h-[95vh] scale-95 data-[open=true]:scale-100 transition-all duration-300 ease-out"
  >
    <span
      class="top-[15px] right-[15px] absolute flex justify-center items-center bg-[var(--color-title)] hover:bg-red-600 p-2 rounded-full w-[45px] h-[45px] font-bold text-[28px] text-white leading-none transition-colors duration-300 cursor-pointer close-button"
      ><svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-full h-full object-contain"
        viewBox="0 0 24 24"
      >
        <path
          fill="#fff"
          d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"
        ></path>
      </svg></span
    >
    <img
      class="block w-auto max-w-full h-auto max-h-[95vh] object-contain"
      id="modalImage"
    />
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("imageModal") as HTMLElement;
    const modalImg = document.getElementById("modalImage") as HTMLImageElement;
    const imageContainers = document.querySelectorAll(".image-container");
    const closeButton = document.querySelector(".close-button");

    imageContainers.forEach((container) => {
      container.addEventListener("click", () => {
        const image = container.querySelector("img");
        if (modal && modalImg && image) {
          modalImg.src = image.src; // Cargar la nueva imagen
          modal.dataset.open = "true";
        }
      });
    });

    const closeModal = () => {
      if (modal) {
        modal.dataset.open = "false";
        // Limpiar el src para evitar que se vea la imagen anterior al reabrir
        if (modalImg) {
          modalImg.src = "";
        }
      }
    };

    if (closeButton) {
      closeButton.addEventListener("click", closeModal);
    }

    // Cerrar modal con la tecla Escape
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeModal();
      }
    });

    if (modal) {
      modal.addEventListener("click", (event) => {
        // Cierra el modal si se hace clic en el fondo
        if (event.target === modal) {
          closeModal();
        }
      });
    }
  });
</script>
